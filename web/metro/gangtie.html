<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta content="width =device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;" name="viewport" />
    <meta content="yes" name="apple-mobile-web-app-capable" />
    <meta content="black" name="apple-mobile-web-app-status-bar-style" />
    <meta content="telephone =no" name="format-detection" />
    <title>港铁</title>
    <meta charset="utf-8" />
    <style>
        body { text-shadow: none !important; }
        .clearfix:after { content: "."; display: block; height: 0px; clear: both; visibility: hidden; }
        /*.ui-overlay-a, .ui-page-theme-a, .ui-page-theme-a .ui-panel-wrapper { background: #fff; text-shadow: none !important; }*/
        #canvas { text-align: center; }
            #canvas > div { left: 0; top: 0; overflow: hidden !important; }

        .indexWrap { background: url(img/start.png); position: absolute; height: 100%; width: 100%; background-size: 100% 100%; top: 0; left: 0; }
            .indexWrap div { text-align: center; position: absolute; bottom: 3em; width: 100%; }
            .indexWrap img { width: 5em; height: 5em; margin: 0.5em; }
        #phone_validate { position: absolute; width: 100%; height: 100%; background: rgba(0,0,0,0.6); top: 0; left: 0; }
            #phone_validate > div { position: absolute; background: url(img/dialog.png); width: 100%; height: 22em; background-size: 100% 100%; top: 50%; margin-top: -11em; text-align: center; }

        .shadow { -webkit-text-stroke: 0.04em #f00; -webkit-text-fill-color: blue; }
        .loading { position: absolute; left: 0; top: 0; width: 100%; height: 100%; display: none; }
            .loading img { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="canvas">
        <img src="images/ajax-loader.gif" />
    </div>
    <div id="loading_1" class="loading"><img src="img/loading_1.gif" /></div>
    <div id="loading_2" class="loading"><img src="img/loading_2.gif" /></div>
</body>
</html>
<script src="jquery-1.8.2.min.js"></script>
<script src="lufylegend-1.9.1.min.js"></script>
<script>
    (function (exp) {
        var userInfo = { sex: 1, name: "用户", openId: "", score:10000 }
        exp.onresize = function () { LGlobal.resize(); }
        LGlobal.destroy = true; //保证游戏中的不用的对象能够顺利被释放
        //LGlobal.preventDefault = false;
        LGlobal.stageScale = LStageScaleMode.EXACT_FIT;
        //全局变量区
        var backLayer, black_bg, passengerLayer;
        var activePassenger = undefined;
        var _con_x, _con_y, stairs_1, stairs_2;
        var game_1_time = 0, game_1_score, game_2_score = 200;
        var game_1_timer, metro;
        var thisGameIndex = 1;

        var isRuning = false;
        //获取随机数
        exp.getRedom = function (minNum, maxNum) {
            switch (arguments.length) {
                case 1: return parseInt(Math.random() * minNum + 1);
                case 2: return parseInt(Math.random() * (maxNum - minNum + 1) + minNum);
                default: return 0;
            }
        }
        LSprite.prototype.align = function (parent) {
            if (parent) {
                this.x = (parent.getWidth() - this.getWidth()) / 2;
            } else {
                this.x = (LGlobal.width - this.getWidth()) / 2;
            }
        }
        LSprite.prototype.isActive = false;
        LSprite.prototype.alignY = function (parent) {
            if (parent) {
                this.y = (parent.getHeight() - this.getHeight()) / 2;
            } else {
                this.y = (LGlobal.height - this.getHeight()) / 2;
            }

        }//居中
        var imgData = new Array(
            { name: "button_endGame", path: "img/Button_endGame.png" },
            { name: "button_reStart", path: "img/Button_reStart.png" },
            { name: "button_share", path: "img/Button_share.png" },

            { name: "stionName", path: "img/stionName.png" },
            { name: "but_brake_1", path: "img/but_brake_1.png" },
            { name: "but_brake_2", path: "img/but_brake_2.png" },
            { name: "rainWay_bg", path: "img/rainWay_bg.png" },
            { name: "over_bg", path: "img/over_bg.png" },

            { name: "number2_0", path: "img/number/number2_0.png" },
            { name: "number2_1", path: "img/number/number2_1.png" },
            { name: "number2_2", path: "img/number/number2_2.png" },
            { name: "number2_3", path: "img/number/number2_3.png" },
            { name: "number2_4", path: "img/number/number2_4.png" },
            { name: "number2_5", path: "img/number/number2_5.png" },
            { name: "number2_6", path: "img/number/number2_6.png" },
            { name: "number2_7", path: "img/number/number2_7.png" },
            { name: "number2_8", path: "img/number/number2_8.png" },
            { name: "number2_9", path: "img/number/number2_9.png" },

            { name: "number1_0", path: "img/number/number1_0.png" },
            { name: "number1_1", path: "img/number/number1_1.png" },
            { name: "number1_2", path: "img/number/number1_2.png" },
            { name: "number1_3", path: "img/number/number1_3.png" },
            { name: "number1_4", path: "img/number/number1_4.png" },
            { name: "number1_5", path: "img/number/number1_5.png" },
            { name: "number1_6", path: "img/number/number1_6.png" },
            { name: "number1_7", path: "img/number/number1_7.png" },
            { name: "number1_8", path: "img/number/number1_8.png" },
            { name: "number1_9", path: "img/number/number1_9.png" },

            { name: "passenger_1", path: "img/passenger/1.png" },
            { name: "passenger_2", path: "img/passenger/2.png" },
            { name: "passenger_3", path: "img/passenger/3.png" },
            { name: "passenger_4", path: "img/passenger/4.png" },
            { name: "passenger_5", path: "img/passenger/5.png" },
            { name: "passenger_6", path: "img/passenger/6.png" },
            { name: "passenger_7", path: "img/passenger/7.png" },
            { name: "passenger_8", path: "img/passenger/8.png" },
            { name: "passenger_9", path: "img/passenger/9.png" },

            { name: "stairs_1", path: "img/stairs_1.png" },
            { name: "stairs_2", path: "img/stairs_2.png" },

            { name: "train_body", path: "img/train_body.png" },
            { name: "train_head", path: "img/train_head.png" },
            { name: "game_1_header", path: "img/game_1_header.png" },
            { name: "btu_play", path: "img/btu_play.png" },
            { name: "game_1_bg", path: "img/game_1_bg.png" },
            { name: "game_hader_1_1", path: "img/game_hader_1_1.png" },
            { name: "game_hader_1_2", path: "img/game_hader_1_2.png" },
            { name: "game_hader_2_1", path: "img/game_hader_2_1.png" },
            { name: "game_hader_2_2", path: "img/game_hader_2_2.png" },
            { name: "ys_btu", path: "img/ys_btu.png" },
            { name: "zs_header", path: "img/zs_header.png" },
            { name: "zs_header_1", path: "img/zs_header_1.png" },
            { name: "mb_bg", path: "img/mb_bg.png" },
            { name: "dialog_header_1", path: "img/dialog_header_2.png" },
            { name: "dialog_header_2", path: "img/dialog_header_2.png" },
            { name: "dialog", path: "img/dialog.png" },
            { name: "init_bg", path: "img/init_bg.png" },
            { name: "start_footer", path: "img/start_footer.png" },
            { name: "start", path: "img/start.png" },
            { name: "weibo", path: "img/Button-micro-blog.png" },
            { name: "weixin", path: "img/Button-micro-channel.png" });
        //乘务员游戏数据
        var levelIndex = 0;
        var gameLevelData = [
            { time: 35, out: 10, into: 0 },
            { time: 30, out: 10, into: 0 },
            { time: 25, out: 10, into: 0 },
            { time: 20, out: 10, into: 0 },
            { time: 15, out: 10, into: 0 },
            { time: 10, out: 10, into: 0 },
        ];

        var levelIndex2 = 0;
        var gameLevelData2 = [
            { speed: 40, acc: 4, name: "清湖1" },
            { speed: 50, acc: 4, name: "清湖2" },
            { speed: 60, acc: 4, name: "清湖3" },
            { speed: 70, acc: 3, name: "清湖4" },
            { speed: 80, acc: 3, name: "清湖5" },
            { speed: 90, acc: 3, name: "清湖6" },
        ];

        function main() {
            LSystem.screen(LStage.FULL_SCREEN);
            backLayer = new LSprite();
            backLayer.graphics.drawRect(1, "#cccccc", [0, 0, LGlobal.width, LGlobal.height], true, "#000000");
            //背景显示
            addChild(backLayer);
            loadingLayer = new LoadingSample1();
            backLayer.addChild(loadingLayer);

            LLoadManage.load(imgData, function (progress) {
                loadingLayer.setProgress(progress);
            }, gameInit);
        }
        //读取完所有图片，进行游戏标题画面的初始化工作
        function gameInit(result) {
            //取得图片读取结果
            imglist = result;
            //移除进度条层//移除或者这样写 loadingLayer.remove();
            backLayer.removeChild(loadingLayer);
            //加入欢迎页
            //gameStart(2);
            //return false;
            backLayer.addChild(initPages.indexPage());
            black_bg = new LSprite();
            black_bg.addChild(new LBitmap(new LBitmapData(imglist["mb_bg"])));

            game_1_score = new Number(0);
        }
        //加载界面
        var initPages = {
            indexPage: function () {
                var returnPage = new LSprite();
                returnPage.addChild(new LBitmap(new LBitmapData(imglist["start"])));
                //var footer = new LBitmap(new LBitmapData(imglist["start_footer"]));
                //footer.y = LGlobal.height - footer.getHeight();
                //footer.x = LGlobal.width - footer.getWidth();
                returnPage.addChild(initPages.footer());
                //加入按钮
                var button2 = new LButton(new LBitmap(new LBitmapData(imglist["weixin"])), new LBitmap(new LBitmapData(imglist["weixin"])));
                button2.x = 157; button2.y = 810;
                button2.addEventListener(LMouseEvent.MOUSE_UP, function () {
                    //微信登录2
                    backLayer.die();
                    backLayer.removeAllChild();
                    backLayer.addChild(initPages.initPage());//进入游戏角色选择页
                    //加入登录提示
                    backLayer.addChild(new DialogMode(1, "每天登录可以得到更多的积分", 24, 2000));
                });

                var button1 = new LButton(new LBitmap(new LBitmapData(imglist["weibo"])), new LBitmap(new LBitmapData(imglist["weibo"])));
                button1.x = 315; button1.y = 810;
                button1.addEventListener(LMouseEvent.MOUSE_UP, function () {
                    //微博登录1
                    backLayer.die();
                    backLayer.removeAllChild();
                    backLayer.addChild(initPages.initPage());//进入游戏角色选择页
                    //加入登录提示
                    backLayer.addChild(new DialogMode(1, "每天登录可以得到更多的积分", 24, 2000));
                });

                returnPage.addChild(button1);
                returnPage.addChild(button2);
                return returnPage;
            },
            initPage: function () {//加载角色选择页面
                var returnPage = new LSprite();
                returnPage.addChild(new LBitmap(new LBitmapData(imglist["init_bg"])));
                returnPage.addChild(initPages.footer());
                //加入左上头像
                var zsHeader = new LSprite();
                var _header = new LSprite();
                _header.addChild(new LBitmap(new LBitmapData(imglist["zs_header_" + userInfo.sex])));
                zsHeader.addChild(new LBitmap(new LBitmapData(imglist["zs_header"])));
                zsHeader.x = 20; zsHeader.y = 20;
                zsHeader.addChild(_header);
                _header.align(zsHeader); _header.alignY(zsHeader);
                returnPage.addChild(zsHeader);
                //加上右上按钮
                var ysBtu = new LSprite();
                ysBtu.addChild(new LBitmap(new LBitmapData(imglist["ys_btu"])));
                ysBtu.y = 20; ysBtu.x = LGlobal.width - ysBtu.getWidth() - 20;
                returnPage.addChild(ysBtu);
                //加入角色选择
                returnPage.addChild(initPages.selectUser());

                return returnPage;
            },
            backBg: function () {
                var returnPage = new LSprite();
                black_bg = new LSprite();
                black_bg.addChild(new LBitmap(new LBitmapData(imglist["mb_bg"])));
                returnPage.addChild(black_bg);
                return returnPage;
            },
            overPage: function (thisScore,allTotal,reStart,end,share) {
                var returnPage = new LSprite();
                returnPage.addChild(new LBitmap(new LBitmapData(imglist["over_bg"])));
                levelIndex = levelIndex2 = 0;//重置游戏关卡数
                //重新开始按钮
                var button_reStart = new LSprite();
                button_reStart.addChild(new LBitmap(new LBitmapData(imglist["button_reStart"])));
                button_reStart.align(); button_reStart.y = 1100;
                button_reStart.addEventListener(LMouseEvent.MOUSE_UP, function (e) { gameStart(thisGameIndex); if (reStart) reStart(); });
                //结束游戏
                var button_endGame = new LSprite();
                button_endGame.addChild(new LBitmap(new LBitmapData(imglist["button_endGame"])));
                button_endGame.align(); button_endGame.y = 1250;
                button_endGame.addEventListener(LMouseEvent.MOUSE_UP, function (e) {
                    backLayer.die();
                    backLayer.removeAllChild();
                    backLayer.addChild(initPages.initPage());//进入游戏角色选择页
                    if (end) end();
                });
                //分享
                var button_share = new LSprite();
                button_share.addChild(new LBitmap(new LBitmapData(imglist["button_share"])));
                button_share.align(); button_share.y = 1400;
                button_endGame.addEventListener(LMouseEvent.MOUSE_UP, function (e) { if (share) share(); });
                //分数
                var _thisScore = new Number(0, 1, 2); _thisScore.y = 840;
                _thisScore.spacing = 10;
                _thisScore.x = LGlobal.width / 2;
                _thisScore.setNumber(thisScore);
                returnPage.addChild(_thisScore);
                //累计分数
                var _allScore = new Number(0, 1, 2); _allScore.y = 950;
                _allScore.spacing = 20; _allScore.scaleX = _allScore.scaleY = 0.4;
                _allScore.x = LGlobal.width / 2 + 20;
                _allScore.setNumber(allTotal);
                returnPage.addChild(_allScore);

                returnPage.addChild(button_reStart);
                returnPage.addChild(button_endGame);
                returnPage.addChild(button_share);
                return returnPage;
            },
            footer: function () {
                var _footer = new LBitmap(new LBitmapData(imglist["start_footer"]));
                _footer.y = LGlobal.height - _footer.getHeight();
                _footer.x = LGlobal.width - _footer.getWidth();
                return _footer;
            },
            selectUser: function () {
                var returnPage = new LSprite();
                var header_1 = new LSprite();
                header_1.addChild(new LBitmap(new LBitmapData(imglist["game_hader_1_2"])));
                var header_2 = new LSprite();
                header_2.addChild(new LBitmap(new LBitmapData(imglist["game_hader_2_1"]))); header_2.x = header_2.getWidth()/2;
                returnPage.addChild(header_1);
                returnPage.addChild(header_2);
                returnPage.y = 225;
                returnPage.align();
                var bindEvent = function (header) {
                    var _zuob = 0;
                    header.addEventListener(LMouseEvent.MOUSE_UP, function (e) {
                        var header2 = (header == header_1 ? header_2 : header_1);
                        if (header.isActive == true) { return false; }
                        var tween = LTweenLite.to(header, 0.3, {
                            scaleX: 1, scaleY: 1, loop: false, ease: LEasing.Sine.easeIn, onUpdate: function (e) { e.alignY(returnPage); }, onComplete: function (e) {
                                returnPage.setChildIndex(e, 1); returnPage.setChildIndex(header2, 2);
                                header.removeAllChild();
                                header2.removeAllChild();
                                if (header == header_1) {
                                    header.addChild(new LBitmap(new LBitmapData(imglist["game_hader_1_1"])));
                                    header2.addChild(new LBitmap(new LBitmapData(imglist["game_hader_2_2"])));
                                } else {
                                    header.addChild(new LBitmap(new LBitmapData(imglist["game_hader_2_1"])));
                                    header2.addChild(new LBitmap(new LBitmapData(imglist["game_hader_1_2"])));
                                }
                                var _button = new LSprite(); _button.y = 225;
                                _button.addChild(new LBitmap(new LBitmapData(imglist["btu_play"])));
                                _button.addEventListener(LMouseEvent.MOUSE_UP, function (e) { gameStart(header == header_1 ? 1 : 2); });
                                header.addChild(_button);
                                header.isActive = true; header2.isActive = false;
                            }
                        });
                        var tween2 = LTweenLite.to(header2, 0.3, {
                            scaleX: 0.9, scaleY: 0.9, loop: false, ease: LEasing.Sine.easeIn, onUpdate: function (e) { e.alignY(returnPage); }, onComplete: function (e) { }
                        });
                    });
                }
                header_1.scaleX = 0.9; header_1.scaleY = 0.9; header_1.alignY(returnPage); header_1.isActive = false; header_2.isActive = true;
                var button = new LSprite(); button.y = 225;
                button.addChild(new LBitmap(new LBitmapData(imglist["btu_play"])));
                button.addEventListener(LMouseEvent.MOUSE_UP, function (e) { gameStart(2); });
                header_2.addChild(button);
                bindEvent(header_1);
                bindEvent(header_2);
                return returnPage;
            }
        }
        //消息页
        function DialogMode(header, text, size, autoHideTime,callBack) {
            base(this, LSprite, []);
            var self = this;
            self.header = header;
            self.text = text;
            self.size = size || 50;
            self.autoHideTime = autoHideTime;
            self.callBack = callBack;
            self.setView();
        }
        DialogMode.prototype.setView = function () {
            var self = this;
            self.addChild(initPages.backBg());
            var dialogBg = new LSprite();
            dialogBg.addChild(new LBitmap(new LBitmapData(imglist["dialog"])));
            dialogBg.align(); dialogBg.y = 315;
            var header = new LSprite();
            header.addChild(new LBitmap(new LBitmapData(imglist["dialog_header_" + self.header])))
            header.align(dialogBg);
            header.y = -header.getHeight() / 2 + 20;
            header.x = header.x + 10;
            dialogBg.addChild(header);
            self.addChild(dialogBg);
            
            var content = new LTextField();
            content.setWordWrap(true, 40);
            content.width = 315;
            content.text = self.text; content.size = self.size; content.color = "#DBAF6E"; content.x = 54; content.y = 90;
            //var shadow = new LDropShadowFilter(5, 90, "#000");//d9ac6a
            //content.filters = [shadow];
            dialogBg.addChild(content);
            if (self.autoHideTime != 0) {
                window.setTimeout(function () {
                    self.remove();
                    black_bg.remove();
                    if (self.callBack) self.callBack();
                }, self.autoHideTime);
            }
            self.addEventListener(LMouseEvent.MOUSE_UP, function (e) {
                self.remove();
                black_bg.remove();
                if (self.callBack) self.callBack();
            });
        }

        //游戏初始化
        exp.gameStart = function (gameIndex) {
            thisGameIndex = gameIndex;
            backLayer.die();
            backLayer.removeAllChild();
            $("#loading_" + gameIndex).fadeIn(700);

            window.setTimeout(function () {
                $("#loading_1,#loading_2").fadeOut();
                if (gameIndex == 1) {
                    //乘务员游戏
                    backLayer.addChild(new LBitmap(new LBitmapData(imglist["game_1_bg"])));
                    //加入乘客层
                    passengerLayer = new LSprite();
                    backLayer.addChild(passengerLayer);
                    //列车
                    var train = new LSprite();
                    var train_head = new LBitmap(new LBitmapData(imglist["train_head"]));
                    var train_body = new LBitmap(new LBitmapData(imglist["train_body"])); train_body.y = train_head.getHeight();
                    train.addChild(train_head); train.addChild(train_body);
                    train.x = LGlobal.width - train.getWidth() - 20; train.y = LGlobal.height;
                    LTweenLite.to(train, 2, {
                        loop: false, ease: LEasing.Sine.easeOut, y: 126, onComplete: function () {
                            game_1_timer = window.setInterval(function () {
                                var _t = parseInt(game_1_time.value);
                                _t -= 1;
                                game_1_time.setNumber(_t);
                                //var returnValue = "";
                                //var ss = 4 - (_t + "").length;
                                //for (var i = 0; i < ss; i++) { returnValue += "0"; }
                                //returnValue += _t;
                                //game_1_time.setNumber(returnValue);
                                if (_t == 0) { window.clearInterval(game_1_timer); }
                            }, 1000);
                            game1();
                        }
                    });
                    backLayer.addChild(train);
                    backLayer.addChild(new LBitmap(new LBitmapData(imglist["game_1_header"])));
                    //加入直达电梯
                    stairs_1 = new LSprite();
                    stairs_1.addChild(new LBitmap(new LBitmapData(imglist["stairs_1"]))); stairs_1.x = 18; stairs_1.y = 112;
                    backLayer.addChild(stairs_1);
                    //加入扶梯
                    stairs_2 = new LSprite();
                    stairs_2.addChild(new LBitmap(new LBitmapData(imglist["stairs_2"]))); stairs_2.x = 12; stairs_2.y = 721;
                    backLayer.addChild(stairs_2);
                    //加入时间
                    //exp.game_1_time = 0;
                    game_1_time = new Number(0, 0.75); game_1_time.defaultlength = 4;
                    game_1_time.x = 47; game_1_time.y = 50;
                    console.log(levelIndex);
                    console.log(gameLevelData[levelIndex].time);
                    game_1_time.setNumber(gameLevelData[levelIndex].time);
                    backLayer.addChild(game_1_time);
                    _game_1_score = game_1_score ? game_1_score.value : 0;
                    game_1_score = new Number(0); game_1_score.defaultlength = 5;
                    game_1_score.x = 158; game_1_score.y = 31;
                    game_1_score.spacing = 27;
                    game_1_score.setNumber(_game_1_score);
                    backLayer.addChild(game_1_score);
                } else if (gameIndex == 2) {
                    //列车员游戏
                    backLayer.addChild(new LBitmap(new LBitmapData(imglist["rainWay_bg"])));
                    //加入站牌
                    var staion = new LSprite();
                    staion.addChild(new LBitmap(new LBitmapData(imglist["stionName"])));
                    staion.x = 30;
                    var shadow = new LDropShadowFilter(5, 90, "#000");//d9ac6a
                    var content = new LTextField();
                    //content.setWordWrap(true, 80);
                    content.width = 700;
                    content.text = gameLevelData2[levelIndex2].name; content.size = 40; content.color = "#fff"; content.x = 80; content.y = 60;
                    content.filters = [shadow];
                    staion.addChild(content);
                    backLayer.addChild(staion);
                    //加入列车
                    metro = new Metro();
                    metro.y = metro.getHeight();
                    metro.speed = gameLevelData2[levelIndex2].speed;
                    metro.ACC = gameLevelData2[levelIndex2].acc;
                    backLayer.addChild(metro);
                    exp.breakTimer;
                    window.setTimeout(function () {
                        //火车驶入
                        var breakButtonBitmap_1 = new LBitmap(new LBitmapData(imglist["but_brake_1"]));
                        var breakButtonBitmap_2 = new LBitmap(new LBitmapData(imglist["but_brake_2"]));
                        var index = 1;
                        breakTimer = window.setInterval(function () {
                            index = index == 1 ? 2 : 1;
                            breakButton.removeAllChild();
                            breakButton.addChild(new LBitmap(new LBitmapData(imglist["but_brake_" + index])));
                        }, 200);
                        backLayer.addEventListener(LEvent.ENTER_FRAME, function () {
                            metro.run();
                        });
                    }, 1000);
                    //加入按钮

                    //var button02 = new LButton(bitmapUp, bitmapOver); button02.x = (LGlobal.width - button02.getWidth()) / 2;

                    var breakButton = new LSprite();
                    breakButton.addChild(new LBitmap(new LBitmapData(imglist["but_brake_1"])));
                    breakButton.align(); breakButton.y = 1800;
                    backLayer.addChild(breakButton);
                    breakButton.addEventListener(LMouseEvent.MOUSE_DOWN, function (e) {
                        window.clearInterval(breakTimer);
                        metro.brake = true;
                    });
                }
            }, 1000);
        }
        //乘客游戏开始
        var game1 = function () {
            backLayer.addChild(passengerLayer);
            var _begin_y = 315; var lastPassenger;
            //game_1_raminP = gameLevelData[levelIndex].out;
            for (var i = 0; i < gameLevelData[levelIndex].out; i++) {
                var passenger = lastPassenger = new Passenger(getRedom(1, 3) == 1 ? "sp" : "nor");
                //if (getRedom(1, 2) == 1) passenger.y = 700; else passenger.y = 1300;
                passenger.y = (!lastPassenger ? 315 : 45 * i + 315);
                passenger.speedX = getRedom(1, 3);
                passenger.speedY = getRedom(-2, 2);
                passengerLayer.addChild(passenger);
            }
            window.setTimeout(function () {
                for (var item in passengerLayer.childList) {
                    passengerLayer.childList[item].state = "auto";
                }
            }, 1000);

            backLayer.addEventListener(LEvent.ENTER_FRAME, function () {
                for (var item in passengerLayer.childList) {
                    if (passengerLayer.childList.hasOwnProperty(item)) { passengerLayer.childList[item].run(); }
                }
                gameState(1);
            });

            backLayer.addEventListener(LMouseEvent.MOUSE_MOVE, function (e) {
                if (!activePassenger) return false;
                if (activePassenger.state != "drag") return false;

                activePassenger.x = e.offsetX - activePassenger.getWidth()/2;
                activePassenger.y = e.offsetY - activePassenger.getHeight()/2;

                //activePassenger.x += e.offsetX - _con_x;
                //activePassenger.y += e.offsetY - _con_y;

                _con_x = e.offsetX;
                _con_y = e.offsetY;
            });
            backLayer.addEventListener(LMouseEvent.MOUSE_UP, function (e) {
                if (!activePassenger) return false;
                var _passenger = activePassenger;
                if (LGlobal.hitTestRect(stairs_1, _passenger)) {
                    if (_passenger.type == "sp") {
                        //console.log(true);//得分
                        //game_1_score.setNumber(parseInt(game_1_score.value) + _passenger.score);
                        _passenger.state = "right";
                    } else {
                        //console.log(false);
                        //window.clearInterval(game_1_timer);
                        //backLayer.die();
                        //backLayer.addChild(new DialogMode(1, "拉错乘客", 40, 2000, function () { backLayer.die(); backLayer.addChild(initPages.overPage()); }));
                        _passenger.state = "wrong";
                    }

                    //game_1_raminP--;
                    //console.log(game_1_raminP);
                    //_passenger.remove();
                    return true;
                }
                if (LGlobal.hitTestRect(stairs_2, _passenger)) {
                    if (_passenger.type == "sp") {
                        //console.log(false);
                        //window.clearInterval(game_1_timer);
                        //backLayer.die();
                        //backLayer.addChild(new DialogMode(1, "拉错乘客", 40, 2000, function () { backLayer.die(); backLayer.addChild(initPages.overPage()); }));
                        _passenger.state = "wrong";
                    } else {
                        //console.log(true);//得分
                        //game_1_score.setNumber(parseInt(game_1_score.value) + _passenger.score);
                        _passenger.state = "right"
                    }

                    //game_1_raminP--;
                    //console.log(game_1_raminP);
                    //_passenger.remove();
                    return true;
                }
                activePassenger.state = "auto";
                activePassenger = undefined;
            });
        }
        //判断游戏1状态
        var gameState = function (gameIndex) {
            if (gameIndex == 1) {
                if (parseInt(game_1_time.value) <= 0) {
                    //时间到
                    backLayer.addChild(new DialogMode(1, "对不起，超时啦，游戏结束", 24, 2000, function () {
                        window.clearInterval(game_1_timer);
                        backLayer.die();
                        backLayer.addChild(initPages.overPage(parseInt(game_1_score.value), game_2_score + parseInt(game_1_score.value) + userInfo.score));
                    }));
                    //console.log("game over");
                }
                if (passengerLayer.childList <= 0) {
                    //游戏过关
                    backLayer.die();
                    window.clearInterval(game_1_timer);
                    if (levelIndex == gameLevelData.length - 1) {
                        backLayer.addChild(new DialogMode(1, "太厉害了，关卡已全部通过，游戏结束", 24, 2000, function () {
                            backLayer.addChild(initPages.overPage(parseInt(game_1_score.value), game_2_score + parseInt(game_1_score.value) + userInfo.score));
                        }));
                        return false;
                    }
                    backLayer.addChild(new DialogMode(1, "恭喜，所有乘客已顺利出站，列车即将进入下一站", 24, 2000, function () {
                        levelIndex++;
                        gameStart(1);
                    }));
                }
            } else if (gameIndex == 2) {
                //console.log(metro.y);
                if (metro.y >= 370 && metro.y <= 585) {
                    backLayer.addChild(new DialogMode(1, "恭喜过关成功！", 24, 2000, function () {
                        if (levelIndex2 == gameLevelData2.length - 1) {
                            backLayer.addChild(new DialogMode(1, "太厉害了，关卡已全部通过，游戏结束", 24, 2000, function () {
                                game_2_score += 100;
                                backLayer.addChild(initPages.overPage(game_2_score, game_2_score + parseInt(game_1_score.value) + userInfo.score));
                            }));
                            return false;
                        }
                        levelIndex2++;
                        gameStart(2);
                    }));
                } else {
                    backLayer.addChild(new DialogMode(1, "对不起，车未停到位", 24, 1000, function () {
                        backLayer.die();
                        backLayer.addChild(initPages.overPage(game_2_score, game_2_score + parseInt(game_1_score.value) + userInfo.score));
                    }));
                }
            }
        }

        //乘客
        function Passenger(type) {
            base(this, LSprite, []);
            var self = this;
            self.type = type;
            self.setView();
        }
        Passenger.prototype.type = 1;
        Passenger.prototype.speedY = 0;
        Passenger.prototype.speedX = 0;
        Passenger.prototype.wayX = "left";
        Passenger.prototype.state = "hold";
        Passenger.prototype.score = 100;
        Passenger.prototype.setView = function () {
            var self = this; var index = 0;
            if (self.type == "sp") {
                self.score = 200;
                index = getRedom(1, 4);
            } else {
                self.score = 100;
                index = getRedom(5, 9);
            }

            self.x = 337;
            self.scaleX = self.scaleY = 0.5;
            var bitmap = new LBitmap(new LBitmapData(imglist["passenger_" + index]));
            bitmap.rotateCenter = false;//这句貌似不怎么管用
            self.addChild(bitmap);
            self.addEventListener(LMouseEvent.MOUSE_DOWN, function (e) {
                self.state = "drag";
                activePassenger = self;
                self.rotate = 0;//将角度归0，不然会影响碰撞检测
                _con_x = e.offsetX;
                _con_y = e.offsetY;

            });
        }
        Passenger.prototype.run = function () {
            var self = this;
            if (self.state == "hold") {
                //self.rotate = -90;
            }else if (self.state == "auto") {
                if (self.x < 22) { self.x = 22; self.speedX = self.speedX * -1; self.wayX = "right" }
                if (self.x > 382 - self.getWidth()) { self.x = 382 - self.getWidth(); self.speedX = self.speedX * -1; self.wayX = "left"; }
                if (self.wayX == "left") {
                    self.rotate = -Math.atan(self.speedY / self.speedX) * 180 / Math.PI - 90;
                } else {
                    self.rotate = -Math.atan(self.speedY / self.speedX) * 180 / Math.PI + 90;
                }
                if (self.y <= 90 || self.y >= LGlobal.height) {
                    //乘客走失
                    self.remove();
                    //gameLevelData[levelIndex].out--;
                    window.clearInterval(game_1_timer);
                    backLayer.addChild(new DialogMode(1, "对不起，乘客走失..", 24, 2000, function () {
                        window.clearInterval(game_1_timer);
                        backLayer.die();
                        backLayer.addChild(initPages.overPage(parseInt(game_1_score.value), parseInt(game_1_score.value) + userInfo.score));
                    }));
                    //gameState(1);
                }
                self.x -= self.speedX;
                self.y += self.speedY;
            } else if (self.state == "wrong") {
                window.clearInterval(game_1_timer);
                backLayer.die();
                backLayer.addChild(new DialogMode(1, "拉错乘客", 24, 2000, function () {
                    backLayer.die();
                    backLayer.addChild(initPages.overPage(parseInt(game_1_score.value), parseInt(game_1_score.value) + userInfo.score));
                }));
            } else if (self.state == "right") {
                //self.state = "auto";
                game_1_score.setNumber(parseInt(game_1_score.value) + self.score);
                LTweenLite.to(self, 0.3, {
                    alpha: 0, scaleY: 0, scaleX: 0, onComplete: function () {
                        self.remove();
                    }
                });

            }
        }

        function Metro() {
            base(this, LSprite, []);
            var self = this;
            self.setView();
        }
        Metro.prototype.setView = function () {
            var train = new LSprite();
            var train_head = new LBitmap(new LBitmapData(imglist["train_head"]));
            var train_body = new LBitmap(new LBitmapData(imglist["train_body"])); train_body.y = train_head.getHeight();
            var train_body2 = new LBitmap(new LBitmapData(imglist["train_body"])); train_body2.y = train_head.getHeight() + train_body.getHeight();
            train.addChild(train_head); train.addChild(train_body); train.addChild(train_body2);
            this.addChild(train);
            this.scaleX = this.scaleY = 0.8;
            this.align(); //train.y = LGlobal.height;

        }
        Metro.prototype.brake = false;
        Metro.prototype.isStop = false;
        Metro.prototype.ACC = 2;
        Metro.prototype.speed = 100;
        Metro.prototype.run = function () {
            var self = this;
            if (self.speed > 0) {
                self.y -= self.speed;
                if (self.brake == true) {
                    self.speed -= self.ACC;
                } else {
                    if (self.y <= -self.getHeight()) {
                        self.y = self.getHeight();
                    }
                }
            } else {
                if (self.isStop == false) {
                    gameState(2);
                    self.isStop = true;
                }
            }
        }

        function Number(num, scale, sharpType) {
            base(this, LSprite, []);
            var self = this;
            self.sharpType = sharpType || "1";
            self.value = num;
            self.scale = scale || 1;
            self.setView(num);
        }
        Number.prototype.value = 0;
        Number.prototype.changeSpeed = 0.1;
        Number.prototype.defaultlength = 0;
        Number.prototype.spacing = 0;//数字间隔
        Number.prototype.scale = 1;//放大倍数
        Number.prototype.sharpType = "1";//数字图形类别
        Number.prototype.singleWidth=0;
        Number.prototype.setView = function (num) {
            var self = this;
            var digit = (num + "").split("");
            var spriteWrap = new LSprite();
            spriteWrap.x = 0;
            for (var i = 0; i < digit.length; i++) {
                var sprite = new LSprite();
                var num = parseInt(digit[i]);
                sprite.addChild(new LBitmap(new LBitmapData(imglist["number" + self.sharpType + "_" + num])));
                sprite.scaleX = sprite.scaleY = self.scale;
                spriteWrap.y = sprite.getHeight() / 2;
                sprite.y = -sprite.getHeight() / 2;
                sprite.x = self.singleWidth = spriteWrap.getWidth() + self.spacing;//i * (sprite.width * self.scale + self.spacing);
                spriteWrap.addChild(sprite);
                self.addChild(spriteWrap);
            }
        }
        Number.prototype.setNumber = function (num, callBack) {
            var self = this;
            self.value = num;
            if (self.defaultlength != 0) {
                var _t = parseInt(num);
                var returnValue = "";
                var ss = self.defaultlength - (_t + "").length;
                for (var i = 0; i < ss; i++) { returnValue += "0"; }
                returnValue += _t;
                num = returnValue;
            }
            var spriteWrap = self.getChildAt(0);
            LTweenLite.to(spriteWrap, self.changeSpeed, {
                scaleY: 0, onComplete: function () {
                    self.removeAllChild();
                    self.setView(num);
                    spriteWrap = self.getChildAt(0);
                    spriteWrap.scaleY = 0;
                    LTweenLite.to(spriteWrap, self.changeSpeed, {
                        scaleY: 1, onComplete: function () {
                            if (callBack) callBack.call(self);
                        }
                    });
                }
            });
        }
        var loadImages = function (url, callBack) {
            var img = new Image(); //创建一个Image对象，实现图片的预下载
            img.onload = function () { img.onload = null; callBack(img); }
            img.src = url;
        }
        init(30, "canvas", 559, 994, function () {
            main();
        });
    })(window);

</script>